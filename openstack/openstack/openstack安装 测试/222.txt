基本服务

网卡设置

第一块网卡设置IP地址，第二块网卡，不需要设置Ip

TYPE=Ethernet
BOOTPROTO=none
NAME=enp8s0
UUID=d19cfe61-dbae-4e06-9c92-14c58e64357c
DEVICE=enp8s0
ONBOOT=yes
重启网络

ifdown enp8s0
ifup enp8s0
NTP

单节点其实可以忽略，不过同步时间对群集是非常重要的事情，所以我也记录一遍，国内建议使用ntp服务器

yum install chrony
编辑 /etc/chrony.conf
server time.soufun.com iburst
重启相关服务
systemctl enable chronyd.service
systemctl start chronyd.service
剩下节点，只需要设置ntp server的IP改成控制节点的ip就可以。
验证

chronyc sources
主机名

为了方便，机器采用主机名进行访问，而不是ip

cat >> /etc/hosts << OFF
192.168.226.50   openstack-node1 openstack-node1.openstack.com
192.168.226.60   openstack-node2 openstack-node2.openstack.com
192.168.226.70   openstack-node3 openstack-node3.openstack.com
OFF
数据库

yum install mariadb mariadb-server MySQL-python
配置

sed -i "/\[mysqld\]$/a character-set-server = utf8" /etc/my.cnf
sed -i "/\[mysqld\]$/a init-connect = 'SET NAMES utf8'" /etc/my.cnf
sed -i "/\[mysqld\]$/a collation-server = utf8_general_ci" /etc/my.cnf
sed -i "/\[mysqld\]$/a innodb_file_per_table" /etc/my.cnf
sed -i "/\[mysqld\]$/a default-storage-engine = innodb" /etc/my.cnf
sed -i "/\[mysqld\]$/a bind-address = 192.168.226.50" /etc/my.cnf
重启服务

systemctl enable mariadb.service
systemctl start mariadb.service
消息队列

yum install -y rabbitmq-server
systemctl enable rabbitmq-server.service
systemctl restart rabbitmq-server.service
创建用户：openstack，设置密码pass
rabbitmqctl add_user openstack 123456
设置权限
rabbitmqctl set_user_tags openstack management
rabbitmqctl set_permissions openstack ".*" ".*" ".*"


设置源,对于CentOS7，我们需要
Base
extra
update
EPEL
OpenStack liberty源
前面3个是CentOS默认启用的源。EPEL源和OpenStack的Liberty源，是需要自己设置，也可以通过安装包来实现自动添加
EPEL
yum -y install http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-7.noarch.rpm
OpenStack liberty

yum install centos-release-openstack-liberty
[centos-openstack-liberty]
name=CentOS-7 - OpenStack liberty
baseurl=http://mirror.centos.org/centos/7/cloud/$basearch/openstack-liberty/
gpgcheck=0
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Cloud

[centos-openstack-liberty-test]
name=CentOS-7 - OpenStack liberty Testing
baseurl=http://buildlogs.centos.org/centos/7/cloud/$basearch/openstack-liberty/
gpgcheck=0
enabled=1
yum upgrade
OpenStack配置工具
yum install -y python-openstackclient openstack-utils
Keystone

24. 安装mysql：
yum install mariadb mariadb-server MySQL-python
25. 将yum下载的配置文件覆盖etc下面的：
cp /usr/share/mysql/my-medium.cnf /etc/my.cnf
26.修改/etc/my.cnf文件：vi /etc/my.cnf
在[mysqld]下添加几个mysql参数
[mysqld] 
default-storage-engine = innodb 
innodb_file_per_table 
collation-server = utf8_general_ci 
init-connect = 'SET NAMES utf8' 
character-set-server = utf8
26. 设置mysql开机启动：
systemctl enable mariadb.service
27. 启动mysql：
systemctl start mariadb.service
28. 设置mysql的root密码：
mysql_secure_installation
29. 第一个回车，第二设置密码，后面的全部选择Y
30. 登录mysql：mysql -u root –p
31. 在mysql里创建openstack里相关服务的数据库，并授权
grant all PRIVILEGES ON *.* to 'root'@'%' identified by '123456';
32. 创建5个服务的数据库

CREATE DATABASE keystone;
CREATE DATABASE glance;
CREATE DATABASE neutron;
CREATE DATABASE nova;
CREATE DATABASE cinder;

#为数据库授权：
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'keystone';
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%'  IDENTIFIED BY 'keystone';
GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'localhost' IDENTIFIED BY 'cinder';
GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'%'  IDENTIFIED BY 'cinder';
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'glance';
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%'  IDENTIFIED BY 'glance';
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'neutron';
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%'  IDENTIFIED BY 'neutron';
GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' IDENTIFIED BY 'nova';
GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%'  IDENTIFIED BY 'nova';


sed -i 's/enabled=0/enabled=1/g' /etc/yum.repos.d/*.repo
sed -i 's/gpgcheck=1/gpgcheck=0/g' /etc/yum.repos.d/*.repo

33.安装rabbitmq-server: 
yum install rabbitmq-server -y

33.将rabbitmq-server加入开机启动：
systemctl enable rabbitmq-server.service
34.启动rabbitmq-server：
systemctl start rabbitmq-server.service

36.创建一个rabbitmq用户：用户名openstack密码openstack

rabbitmqctl add_user openstack 123456
 
37.查看rabbitmq启动端口(5672):netstat –netlp
rabbitmqctl set_user_tags openstack management

38.为用户设置权限：

rabbitmqctl set_permissions openstack ".*" ".*" ".*"

39.添加rabbitmq的web插件：

rabbitmq-plugins enable rabbitmq_management

40.启动rabbitmq的web插件(监控5567端口)

systemctl restart rabbitmq-server.service
systemctl enable rabbitmq-server.service
41.查看是否启动成功(15672)：netstat –netlp

42.访问rabbitmqweb页面

http://openstack-node1:15672

43.使创建的rabbitmq的openstack用户能登录rabbitmqweb
点击openstack用户在新的页面找到update this user
退出重新登录测试设置成功

44.44.组件安装
yum -y install openstack-keystone httpd mod_wsgi memcached python-memcached
配置

编辑 /etc/keystone/keystone.conf

[DEFAULT] 
admin_token = ADMIN 
[database] 
connection = mysql://keystone:pass@openstack-node1/keystone

[memcache] 
servers = localhost:11211
[token]
provider = uuid 
driver = memcache 
[revoke] 
driver = sql

手工修改很麻烦，红帽提供工具修改

openstack-config --set /etc/keystone/keystone.conf DEFAULT admin_token ADMIN
openstack-config --set /etc/keystone/keystone.conf database connection mysql://keystone:pass@openstack-node1/keystone
openstack-config --set /etc/keystone/keystone.conf memcache servers localhost:11211
openstack-config --set /etc/keystone/keystone.conf token provider uuid
openstack-config --set /etc/keystone/keystone.conf token driver memcache
openstack-config --set /etc/keystone/keystone.conf revoke driver sql
配置Apache

sed -i "s/#ServerName www.example.com:80/ServerName openstack-node1/" /etc/httpd/conf/httpd.conf
创建apache启动的配置文件

cat > /etc/httpd/conf.d/wsgi-keystone.conf << OFF
Listen 5000
Listen 35357
<VirtualHost *:5000>
  WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
  WSGIProcessGroup keystone-public
  WSGIScriptAlias / /usr/bin/keystone-wsgi-public
  WSGIApplicationGroup %{GLOBAL}
  WSGIPassAuthorization On
  <IfVersion >= 2.4>
    ErrorLogFormat "%{cu}t %M"
  </IfVersion>
  ErrorLog /var/log/httpd/keystone-error.log
  CustomLog /var/log/httpd/keystone-access.log combined
  <Directory /usr/bin>
    <IfVersion >= 2.4>
      Require all granted
    </IfVersion>
    <IfVersion < 2.4>
      Order allow,deny
      Allow from all
    </IfVersion>
  </Directory>
</VirtualHost>
<VirtualHost *:35357>
  WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
  WSGIProcessGroup keystone-admin
  WSGIScriptAlias / /usr/bin/keystone-wsgi-admin
  WSGIApplicationGroup %{GLOBAL}
  WSGIPassAuthorization On
  <IfVersion >= 2.4>
    ErrorLogFormat "%{cu}t %M"
  </IfVersion>
  ErrorLog /var/log/httpd/keystone-error.log
  CustomLog /var/log/httpd/keystone-access.log combined
  <Directory /usr/bin>
    <IfVersion >= 2.4>
      Require all granted
    </IfVersion>
    <IfVersion < 2.4>
      Order allow,deny
      Allow from all
    </IfVersion>
  </Directory>
</VirtualHost>
OFF
启动服务

systemctl enable memcached.service
systemctl start memcached.service
systemctl enable httpd.service
systemctl start httpd.service
初始化数据库

su -s /bin/sh -c "keystone-manage db_sync" keystone
45.服务和Endpoint

文档把public，internal和admin3种网络都使用一个网段

设置临时环境变量

export OS_TOKEN=28d6aa1211777585cf17
export OS_URL=http://openstack-node1:35357/v3
export OS_IDENTITY_API_VERSION=3

openstack service create --name keystone --description "OpenStack Identity" identity
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | OpenStack Identity               |
| enabled     | True                             |
| id          | 1f0c06d4c83c4975ad8306037b76793d |
| name        | keystone                         |
| type        | identity                         |
+-------------+----------------------------------+

openstack endpoint create --region RegionOne identity public http://openstack-node1:5000/v2.0
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 0ffc2680703f4cc9aa95c85564440f27 |
| interface    | public                           |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 1f0c06d4c83c4975ad8306037b76793d |
| service_name | keystone                         |
| service_type | identity                         |
| url          | http://openstack-node1:5000/v2.0 |
+--------------+----------------------------------+

openstack endpoint create --region RegionOne identity internal http://openstack-node1:5000/v2.0
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 1a83400d9f2640b1a86a303435d058be |
| interface    | internal                         |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 1f0c06d4c83c4975ad8306037b76793d |
| service_name | keystone                         |
| service_type | identity                         |
| url          | http://openstack-node1:5000/v2.0 |
+--------------+----------------------------------+

openstack endpoint create --region RegionOne identity admin http://openstack-node1:35357/v2.0
+--------------+-----------------------------------+
| Field        | Value                             |
+--------------+-----------------------------------+
| enabled      | True                              |
| id           | 84ebfc3646c74c58a7e1523378a72d43  |
| interface    | admin                             |
| region       | RegionOne                         |
| region_id    | RegionOne                         |
| service_id   | 1f0c06d4c83c4975ad8306037b76793d  |
| service_name | keystone                          |
| service_type | identity                          |
| url          | http://openstack-node1:35357/v2.0 |
+--------------+-----------------------------------+

openstack project create --domain default --description "Admin Project" admin
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | Admin Project                    |
| domain_id   | default                          |
| enabled     | True                             |
| id          | 268be3664e10464d99461705eb37d3ed |
| is_domain   | False                            |
| name        | admin                            |
| parent_id   | None                             |
+-------------+----------------------------------+

openstack user create admin --domain default --password admin
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | default                          |
| enabled   | True                             |
| id        | b7a52bf25f0b45f3972eb562419cd8be |
| name      | admin                            |
+-----------+----------------------------------+

openstack role create admin
+-------+----------------------------------+
| Field | Value                            |
+-------+----------------------------------+
| id    | 0a36b87fd1364339b0d01fea8ac5fa9c |
| name  | admin                            |
+-------+----------------------------------+

openstack role add --project admin --user admin admin
openstack project create --domain default --description "Service Project" service
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | Service Project                  |
| domain_id   | default                          |
| enabled     | True                             |
| id          | 207addb47f624c689f3a659d8182ff01 |
| is_domain   | False                            |
| name        | service                          |
| parent_id   | None                             |
+-------------+----------------------------------+

openstack project create --domain default --description "Demo Project" demo
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | Demo Project                     |
| domain_id   | default                          |
| enabled     | True                             |
| id          | 26fffce3eacc42d0aa54f6445537b1ee |
| is_domain   | False                            |
| name        | demo                             |
| parent_id   | None                             |
+-------------+----------------------------------+

openstack user create demo --domain default --password demo
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | default                          |
| enabled   | True                             |
| id        | 7c96abea0f0b419899f6f1105aecee04 |
| name      | demo                             |
+-----------+----------------------------------+

openstack role create user
+-------+----------------------------------+
| Field | Value                            |
+-------+----------------------------------+
| id    | 381ee79b7ac74a78b214bde729ee62fa |
| name  | user                             |
+-------+----------------------------------+

openstack role add --project demo --user demo user

77.取消之前用export设置的变量用unset 命令：
unset OS_TOKEN
unset OS_URL
unset OS_IDENTITY_API_VERSION
78.验证keystone是否安装成功。获取admin用户的令牌：需要属于设置的密码：admin
openstack --os-auth-url http://openstack-node1:35357/v3 \
--os-project-domain-id default --os-user-domain-id default \
--os-project-name admin --os-username admin --os-auth-type password \
token issue
+------------+----------------------------------+
| Field      | Value                            |
+------------+----------------------------------+
| expires    | 2016-08-08T04:28:02.159936Z      |
| id         | 7cf0eb30ce95429a8412ad4fa3be259d |
| project_id | 268be3664e10464d99461705eb37d3ed |
| user_id    | b7a52bf25f0b45f3972eb562419cd8be |
+------------+----------------------------------+

79.获取demo用户的令牌：需要属于设置的密码：demo
openstack --os-auth-url http://openstack-node1:35357/v3 \
--os-project-domain-id default --os-user-domain-id default \
--os-project-name demo --os-username demo --os-auth-type password \
token issue
+------------+----------------------------------+
| Field      | Value                            |
+------------+----------------------------------+
| expires    | 2016-08-08T04:28:15.591831Z      |
| id         | 4f273b0d0f4246aa8634677d257260eb |
| project_id | 26fffce3eacc42d0aa54f6445537b1ee |
| user_id    | 7c96abea0f0b419899f6f1105aecee04 |
+------------+----------------------------------+
检测设置

80.在root目录创建一个admin用户使用keystone的脚本环境文件

cat > /root/admin-openrc.sh << OFF
export OS_PROJECT_DOMAIN_ID=default
export OS_USER_DOMAIN_ID=default
export OS_PROJECT_NAME=admin
export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=admin
export OS_AUTH_URL=http://openstack-node1:35357/v3
export OS_IDENTITY_API_VERSION=3
OFF


cat > /root/demo-openrc.sh << OFF
export OS_PROJECT_DOMAIN_ID=default
export OS_USER_DOMAIN_ID=default
export OS_PROJECT_NAME=demo
export OS_TENANT_NAME=demo
export OS_USERNAME=demo
export OS_PASSWORD=demo
export OS_AUTH_URL=http://openstack-node1:5000/v3
export OS_IDENTITY_API_VERSION=3
OFF
82.加载admin-openrc.sh文件
source admin-openrc.sh
83.校验文件是否配置ok
[root@openstack-node1 ~]# openstack token issue
+------------+----------------------------------+
| Field      | Value                            |
+------------+----------------------------------+
| expires    | 2016-08-08T04:28:51.956980Z      |
| id         | 83295c95488c4d0e926191c2efe93bce |
| project_id | 268be3664e10464d99461705eb37d3ed |
| user_id    | b7a52bf25f0b45f3972eb562419cd8be |
+------------+----------------------------------+

84.看到以上结果表明我们的keystone已安装成功，下面开始安装另外一个服务关于镜像的glance服务



86.创建一个glance用户

 
openstack user create glance --domain default --password glance
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | default                          |
| enabled   | True                             |
| id        | 0bfb2b746c1a49c08b9e078b02d754c7 |
| name      | glance                           |
+-----------+----------------------------------+
87.将glance用户赋予admin角色添加道service项目里－改命令没有输出
openstack role add --project service --user glance admin
88.创建一个镜像服务，服务类型：imag
openstack service create --name glance  --description "OpenStack Image service" image
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | OpenStack Image service          |
| enabled     | True                             |
| id          | 07857c1c48134bedbccdd5000c67964d |
| name        | glance                           |
| type        | image                            |
+-------------+----------------------------------+
89.创建一个公共的endpoint——注意修改ip
openstack endpoint create --region RegionOne   image public http://openstack-node1:9292
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 303bbd42d3f040d29ae38ee74673de54 |
| interface    | public                           |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 07857c1c48134bedbccdd5000c67964d |
| service_name | glance                           |
| service_type | image                            |
| url          | http://openstack-node1:9292      |
+--------------+----------------------------------+
90.创建一个内部的endpoint
openstack endpoint create --region RegionOne   image internal http://openstack-node1:9292
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | ba752c4889b44cc9a02e37005f28a92d |
| interface    | internal                         |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 07857c1c48134bedbccdd5000c67964d |
| service_name | glance                           |
| service_type | image                            |
| url          | http://openstack-node1:9292      |
+--------------+----------------------------------+
91.创建一个admin的endpoint
openstack endpoint create --region RegionOne   image admin http://openstack-node1:9292
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 58e86181cb5e4e1d9bece92491179b9f |
| interface    | admin                            |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 07857c1c48134bedbccdd5000c67964d |
| service_name | glance                           |
| service_type | image                            |
| url          | http://openstack-node1:9292      |
+--------------+----------------------------------+
92.使用yum安装glance需要的组件——如果某个rpm包安装失败，请多尝试几次。后期考虑做一个openstack的私有yum源
yum -y install openstack-glance python-glance python-glanceclient
93.glance服务需要修改两个配置文件一个是glance-api.conf,文件一个是glance-registry.conf文件。首先修改glance-api.conf,文件
94.修改glance-api.conf还是和之前修改keystone的配置文件一样，下面列出里需要修改的变量与在文件的行数，便于查找:


94-1: 修改glance-register.conf还是和之前修改keystone的配置文件一样，下面列出里需要修改的变量与在文件的行数，便于查找:
openstack-config --set /etc/glance/glance-api.conf database  connection mysql://glance:glance@openstack-node1/glance
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken  auth_uri http://openstack-node1:5000
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken  auth_url http://openstack-node1:35357
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken  auth_plugin  password
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken  project_domain_id  default
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken  user_domain_id default
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken  project_name service
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken  username glance
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken  password  glance
openstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone
openstack-config --set /etc/glance/glance-api.conf glance_store default_store file
openstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/
openstack-config --set /etc/glance/glance-api.conf DEFAULT notification_driver noop
openstack-config --set /etc/glance/glance-api.conf DEFAULT verbose True
openstack-config --set /etc/glance/glance-registry.conf database connection mysql://glance:glance@openstack-node1/glance
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken  auth_uri http://openstack-node1:5000
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken  auth_url http://openstack-node1:35357
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken  auth_plugin  password
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken  project_domain_id  default
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken  user_domain_id default
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken  project_name service
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken  username glance
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken  password  glance
openstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone
openstack-config --set /etc/glance/glance-registry.conf DEFAULT notification_driver noop
openstack-config --set /etc/glance/glance-registry.conf DEFAULT verbose True
 

95.同步glance数据库,记得去mysql里去查看glance数据库里是否生成表

# su -s /bin/sh -c "glance-manage db_sync" glance
96.设置glance服务开机启动与现在启动

systemctl enable openstack-glance-api.service openstack-glance-registry.service
systemctl restart openstack-glance-api.service openstack-glance-registry.service
97.在／root目录，将glance的一个环境变量添加道之前设置的admin-openr.sh和demo-openrc.是里
echo "export OS_IMAGE_API_VERSION=2" | tee -a admin-openrc.sh demo-openrc.sh
98.使用环境脚本

source admin-openrc.sh
99.下载测试的镜像。可选择一个制定目录如/home

wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img
100.上传镜像，在镜像存放的目录执行下面的命令

[root@openstack-node1 ~]# glance image-create --name "Acirros" \
--file cirros-0.3.4-x86_64-disk.img \
--disk-format qcow2 --container-format bare \
--visibility public --progress
[=============================>] 100%
+------------------+--------------------------------------+
| Property         | Value                                |
+------------------+--------------------------------------+
| checksum         | ee1eca47dc88f4879d8a229cc70a07c6     |
| container_format | bare                                 |
| created_at       | 2016-08-08T07:31:40Z                 |
| disk_format      | qcow2                                |
| id               | 289a52a6-6317-487b-a41b-3ba06852622e |
| min_disk         | 0                                    |
| min_ram          | 0                                    |
| name             | cirros                               |
| owner            | 268be3664e10464d99461705eb37d3ed     |
| protected        | False                                |
| size             | 13287936                             |
| status           | active                               |
| tags             | []                                   |
| updated_at       | 2016-08-08T07:31:41Z                 |
| virtual_size     | None                                 |
| visibility       | public                               |
+------------------+--------------------------------------+
[root@openstack-node1 ~]# glance image-list
+--------------------------------------+--------+
| ID                                   | Name   |
+--------------------------------------+--------+
| 289a52a6-6317-487b-a41b-3ba06852622e | cirros |
+--------------------------------------+--------+

8、控制节点配置nova服务
创建nova数据库
创建nova服务和api endpoints
source admin-openrc.sh
openstack user create nova  --domain default --password nova
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | default                          |
| enabled   | True                             |
| id        | 4671d37a1d6e48b980ba262f37778b47 |
| name      | nova                             |
+-----------+----------------------------------+

openstack role add --project service --user nova admin 
openstack service create --name nova --description "OpenStack Compute" compute3
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | OpenStack Compute                |
| enabled     | True                             |
| id          | 0f74445d42f0417f91f05d9fabc89447 |
| name        | nova                             |
| type        | compute                          |
+-------------+----------------------------------+
openstack endpoint create --region RegionOne compute public http://openstack-node1:8774/v2/%\(tenant_id\)s
+--------------+----------------------------------------------+
| Field        | Value                                        |
+--------------+----------------------------------------------+
| enabled      | True                                         |
| id           | cc7dcb06382b4b2683e3cd2e93fd1d48             |
| interface    | public                                       |
| region       | RegionOne                                    |
| region_id    | RegionOne                                    |
| service_id   | 0f74445d42f0417f91f05d9fabc89447             |
| service_name | nova                                         |
| service_type | compute                                      |
| url          | http://openstack-node1:8774/v2/%(tenant_id)s |
+--------------+----------------------------------------------+

openstack endpoint create --region RegionOne compute internal http://openstack-node1:8774/v2/%\(tenant_id\)s
+--------------+----------------------------------------------+
| Field        | Value                                        |
+--------------+----------------------------------------------+
| enabled      | True                                         |
| id           | 5dc96f4168014722aeef749144b33e1e             |
| interface    | internal                                     |
| region       | RegionOne                                    |
| region_id    | RegionOne                                    |
| service_id   | 0f74445d42f0417f91f05d9fabc89447             |
| service_name | nova                                         |
| service_type | compute                                      |
| url          | http://openstack-node1:8774/v2/%(tenant_id)s |
+--------------+----------------------------------------------+

openstack endpoint create --region RegionOne compute admin http://openstack-node1:8774/v2/%\(tenant_id\)s
+--------------+----------------------------------------------+
| Field        | Value                                        |
+--------------+----------------------------------------------+
| enabled      | True                                         |
| id           | 771d2e210a0747a4a15dd656a41f8066             |
| interface    | admin                                        |
| region       | RegionOne                                    |
| region_id    | RegionOne                                    |
| service_id   | 0f74445d42f0417f91f05d9fabc89447             |
| service_name | nova                                         |
| service_type | compute                                      |
| url          | http://openstack-node1:8774/v2/%(tenant_id)s |
+--------------+----------------------------------------------+
安装nova软件包

yum -y install openstack-nova-api openstack-nova-cert \
openstack-nova-conductor openstack-nova-console \
openstack-nova-novncproxy openstack-nova-scheduler \
python-novaclient --nogpgcheck

配置nova
openstack-config --set /etc/nova/nova.conf database connection mysql://nova:nova@openstack-node1/nova
openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit
openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host openstack-node1
openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack
openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password 123456
openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone
openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://openstack-node1:5000
openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://openstack-node1:35357
openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_plugin password
openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_id default
openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_id default
openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service
openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova
openstack-config --set /etc/nova/nova.conf keystone_authtoken password nova
openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 192.168.226.50
openstack-config --set /etc/nova/nova.conf DEFAULT network_api_class nova.network.neutronv2.api.API
openstack-config --set /etc/nova/nova.conf DEFAULT security_group_api neutron
openstack-config --set /etc/nova/nova.conf DEFAULT linuxnet_interface_driver nova.network.linux_net.NeutronLinuxBridgeInterfaceDriver
openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
openstack-config --set /etc/nova/nova.conf vnc vncserver_listen $my_ip
openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address $my_ip
openstack-config --set /etc/nova/nova.conf glance host openstack-node1
openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp
openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata
openstack-config --set /etc/nova/nova.conf DEFAULT verbose True
同步nova数据库,启动nova服务并设置自启
su -s /bin/sh -c "nova-manage db sync" nova 
systemctl enable openstack-nova-api.service \
openstack-nova-cert.service openstack-nova-consoleauth.service \
openstack-nova-scheduler.service openstack-nova-conductor.service \
openstack-nova-novncproxy.service

systemctl restart openstack-nova-api.service \
openstack-nova-cert.service openstack-nova-consoleauth.service \
openstack-nova-scheduler.service openstack-nova-conductor.service \
openstack-nova-novncproxy.service

9、计算节点安装nova服务
安装nova软件包
yum -y install openstack-nova-compute sysfsutils openstack-utils 
修改nova配置
openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit
openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host openstack-node1
openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack
openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password 123456
openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone
openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://openstack-node1:5000
openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://openstack-node1:35357
openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_plugin password
openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_id default
openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_id default
openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service
openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova
openstack-config --set /etc/nova/nova.conf keystone_authtoken password nova
openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 192.168.226.70
openstack-config --set /etc/nova/nova.conf DEFAULT network_api_class nova.network.neutronv2.api.API
openstack-config --set /etc/nova/nova.conf DEFAULT security_group_api neutron
openstack-config --set /etc/nova/nova.conf DEFAULT linuxnet_interface_driver nova.network.linux_net.NeutronLinuxBridgeInterfaceDriver
openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
openstack-config --set /etc/nova/nova.conf vnc enabled True
openstack-config --set /etc/nova/nova.conf vnc vncserver_listen  0.0.0.0
openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address $my_ip
openstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://openstack-node1:6080/vnc_auto.html
openstack-config --set /etc/nova/nova.conf glance host openstack-node1
openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp
openstack-config --set /etc/nova/nova.conf DEFAULT verbose True 
openstack-config --set /etc/nova/nova.conf libvirt virt_type qemu 
启动nova服务，并设置自启
systemctl enable libvirtd.service openstack-nova-compute.service
systemctl restart libvirtd.service openstack-nova-compute.service
10、主控节点验证nova服务
修改环境变量（官网未变）
echo "export OS_REGION_NAME=RegionOne" >> admin-openrc.sh
source admin-openrc.sh
验证
[root@openstack-node1 ~]# nova service-list
+----+------------------+-----------------+----------+---------+-------+----------------------------+-----------------+
| Id | Binary           | Host            | Zone     | Status  | State | Updated_at                 | Disabled Reason |
+----+------------------+-----------------+----------+---------+-------+----------------------------+-----------------+
| 1  | nova-conductor   | openstack-node1 | internal | enabled | up    | 2016-08-08T08:45:42.000000 | -               |
| 2  | nova-consoleauth | openstack-node1 | internal | enabled | up    | 2016-08-08T08:45:42.000000 | -               |
| 3  | nova-scheduler   | openstack-node1 | internal | enabled | up    | 2016-08-08T08:45:44.000000 | -               |
| 4  | nova-cert        | openstack-node1 | internal | enabled | up    | 2016-08-08T08:45:37.000000 | -               |
| 5  | nova-compute     | openstack-node3 | nova     | enabled | up    | 2016-08-08T08:45:42.000000 | -               |
+----+------------------+-----------------+----------+---------+-------+----------------------------+-----------------+
[root@openstack-node1 ~]# nova endpoints
+-----------+----------------------------------+
| keystone  | Value                            |
+-----------+----------------------------------+
| id        | 0ffc2680703f4cc9aa95c85564440f27 |
| interface | public                           |
| region    | RegionOne                        |
| region_id | RegionOne                        |
| url       | http://openstack-node1:5000/v2.0 |
+-----------+----------------------------------+
+-----------+----------------------------------+
| glance    | Value                            |
+-----------+----------------------------------+
| id        | 303bbd42d3f040d29ae38ee74673de54 |
| interface | public                           |
| region    | RegionOne                        |
| region_id | RegionOne                        |
| url       | http://openstack-node1:9292      |
+-----------+----------------------------------+
+-----------+-----------------------------------------------------------------+
| nova      | Value                                                           |
+-----------+-----------------------------------------------------------------+
| id        | 5dc96f4168014722aeef749144b33e1e                                |
| interface | internal                                                        |
| region    | RegionOne                                                       |
| region_id | RegionOne                                                       |
| url       | http://openstack-node1:8774/v2/268be3664e10464d99461705eb37d3ed |
+-----------+-----------------------------------------------------------------+
WARNING: glance has no endpoint in RegionOne! Available endpoints for this service:


11、openstack-node1 node Networking service

创建neutron数据库
mysql -e "CREATE DATABASE neutron;"
mysql -e "GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'neutron';"
mysql -e "GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'neutron';"

创建neutron服务和api endpoints
source admin-openrc.sh
openstack user create neutron --domain default --password neutron
openstack role add --project service --user neutron admin
openstack service create --name neutron --description "OpenStack Networking" network
openstack endpoint create --region RegionOne network public http://openstack-node1:9696
openstack endpoint create --region RegionOne network internal http://openstack-node1:9696
openstack endpoint create --region RegionOne network admin http://openstack-node1:9696

11、openstack-node1 Provider networks

安装软件包
yum -y install openstack-neutron openstack-neutron-ml2 \
openstack-neutron-linuxbridge python-neutronclient ebtables ipset


openstack-config --set /etc/neutron/neutron.conf database connection mysql://neutron:neutron@openstack-node1/neutron
openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2
openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins router
openstack-config --set /etc/neutron/neutron.conf DEFAULT allow_overlapping_ips True
openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit
openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host openstack-node1
openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack
openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password 123456
openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://openstack-node1:5000
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://openstack-node1:35357
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_plugin password
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_id default
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_id default
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password neutron
openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True
openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True
openstack-config --set /etc/neutron/neutron.conf DEFAULT nova_url http://openstack-node1:8774/v2
openstack-config --set /etc/neutron/neutron.conf nova auth_url http://openstack-node1:35357
openstack-config --set /etc/neutron/neutron.conf nova auth_plugin password
openstack-config --set /etc/neutron/neutron.conf nova project_domain_id default
openstack-config --set /etc/neutron/neutron.conf nova user_domain_id default
openstack-config --set /etc/neutron/neutron.conf nova region_name RegionOne
openstack-config --set /etc/neutron/neutron.conf nova project_name service
openstack-config --set /etc/neutron/neutron.conf nova username nova
openstack-config --set /etc/neutron/neutron.conf nova password nova
openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp
openstack-config --set /etc/neutron/neutron.conf DEFAULT verbose True


12、openstack-node1完成neutron安装

配置文件
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT auth_uri http://openstack-node1:5000
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT auth_url http://openstack-node1:35357  
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT auth_region RegionOne  
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT auth_plugin password  
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT project_domain_id  default
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT user_domain_id default
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT project_name  service 
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT username  neutron
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT password  neutron
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip  openstack-node1 
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret neutron 
openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT verbose  True
openstack-config --set /etc/nova/nova.conf neutron url http://openstack-node1:9696 
openstack-config --set /etc/nova/nova.conf neutron auth_url http://openstack-node1:35357 
openstack-config --set /etc/nova/nova.conf neutron auth_plugin password
openstack-config --set /etc/nova/nova.conf neutron project_domain_id  default
openstack-config --set /etc/nova/nova.conf neutron user_domain_id  default
openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne
openstack-config --set /etc/nova/nova.conf neutron project_name service 
openstack-config --set /etc/nova/nova.conf neutron username neutron 
openstack-config --set /etc/nova/nova.conf neutron password neutron 
openstack-config --set /etc/nova/nova.conf neutron service_metadata_proxy  True
openstack-config --set /etc/nova/nova.conf neutron metadata_proxy_shared_secret  neutron


同步数据，启动并设置自启
ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini

su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron

systemctl restart openstack-nova-api.service

systemctl enable neutron-server.service \
neutron-linuxbridge-agent.service neutron-dhcp-agent.service \
neutron-metadata-agent.service

systemctl start neutron-server.service \
neutron-linuxbridge-agent.service neutron-dhcp-agent.service \
neutron-metadata-agent.service

systemctl enable neutron-l3-agent.service
systemctl restart neutron-l3-agent.service

13、Compute node Networking service
13、Compute node Networking service

安装neutron软件包
yum -y install openstack-neutron openstack-neutron-linuxbridge ebtables ipset

配置neutron
openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit
openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller
openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack
openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password 123456
openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_plugin password
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_id default
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_id default
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron
openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password neutron
openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp
openstack-config --set /etc/neutron/neutron.conf DEFAULT verbose True


openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings public:eno16777728
openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False
openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini agent prevent_arp_spoofing True
openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True
openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver  neutron.agent.linux.iptables_firewall.IptablesFirewallDriver